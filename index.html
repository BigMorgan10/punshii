<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Punchii Battle ‚Äì Scientific Breakthrough ‚ö°</title>
  <meta name="description" content="Punchii Battle : IA mastering, NFT, PWA, Web3, eye-tracking ‚Äì tout en un fichier."/>
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUHVuY2hpaSBCYXR0bGUiLCJzaG9ydF9uYW1lIjoiUHVuY2hpaSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDBmZmU3IiwidGhlbWVfY29sb3IiOiIjMDBmZmU3In0="/>
  <style>
    :root{--bg:#0a0a0a;--accent:#00ffe7;--text:#fff;--surface:#111;}
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif}
    body{background:var(--bg);color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:var(--surface)}
    .logo{font-weight:900;font-size:1.5rem;color:var(--accent);text-shadow:0 0 5px var(--accent)}
    nav a{margin-left:1rem;color:var(--text);text-decoration:none}
    .hero{height:60vh;display:flex;flex-direction:column;justify-content:center;align-items:center}
    #timer{font-size:3rem;color:var(--accent)}
    .battle{display:grid;grid-template-columns:1fr 1fr;gap:2rem;max-width:1200px;margin:2rem auto;padding:0 1rem}
    .track{background:var(--surface);padding:1.5rem;border-radius:12px;text-align:center}
    .track audio{width:100%;margin:1rem 0}
    canvas{width:100%;height:60px;background:#000;margin:.5rem 0;border-radius:4px}
    .btn{background:var(--accent);color:var(--bg);border:none;padding:.8rem 2rem;border-radius:25px;cursor:pointer}
    .upload-zone{border:2px dashed var(--accent);padding:2rem;margin:2rem auto;max-width:500px;text-align:center;border-radius:12px;cursor:pointer}
    footer{text-align:center;padding:2rem;font-size:.8rem;opacity:.5}
    @media(max-width:700px){.battle{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <div class="logo">‚ö° PUNCHII BATTLE ‚Äì SCIENCE EDITION</div>
  <nav>
    <button class="btn" onclick="login()">Connexion Web3</button>
  </nav>
</header>

<section class="hero">
  <h1>Next-Gen Audio Battle Arena</h1>
  <div id="timer">‚è≥ 24:00:00</div>
</section>

<section class="battle">
  <div class="track">
    <h2 id="t1">Chargement‚Ä¶</h2>
    <audio id="a1" controls crossorigin></audio>
    <canvas id="c1"></canvas>
    <button class="btn" onclick="vote('p1')">üî• Voter</button>
  </div>
  <div class="track">
    <h2 id="t2">Chargement‚Ä¶</h2>
    <audio id="a2" controls crossorigin></audio>
    <canvas id="c2"></canvas>
    <button class="btn" onclick="vote('p2')">üí• Voter</button>
  </div>
</section>

<section id="upload">
  <h2 style="text-align:center">Upload + IA Mastering</h2>
  <div class="upload-zone" onclick="fileInput.click()">
    <p>üéµ Glisse ton MP3 ici</p>
    <input type="file" id="fileInput" accept="audio/*" style="display:none">
  </div>
  <input id="title" placeholder="Titre" style="width:100%;max-width:400px;display:block;margin:0 auto 1rem;padding:.8rem;border:none;border-radius:8px">
  <label><input type="checkbox" id="aiMaster"> IA Mastering</label>
  <button class="btn" onclick="upload()">üì§ Upload & Mint NFT</button>
  <p id="status" style="text-align:center;margin-top:1rem"></p>
</section>

<section id="shop" style="max-width:600px;margin:2rem auto;text-align:center">
  <h2>Boutique NFT</h2>
  <button class="btn" onclick="mintNFT('tee')">Mint Tee NFT (25‚Ç¨)</button>
  <button class="btn" onclick="mintNFT('album')">Mint Album NFT (7‚Ç¨)</button>
</section>

<footer>¬© 2024 Punchii Battle ‚Äì IA + NFT + PWA + Web3</footer>

<!-- Web3 + Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "123456789",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// PWA sw
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("data:text/javascript,importScripts('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js');self.addEventListener('fetch',e=>{})");
}

// Timer
let end = +localStorage.getItem("end") || Date.now() + 24*3600*1000;
localStorage.setItem("end", end);
setInterval(() => {
  const rest = Math.max(0, end - Date.now());
  const h = String(Math.floor(rest/3600000)).padStart(2,"0");
  const m = String(Math.floor((rest%3600000)/60000)).padStart(2,"0");
  const s = String(Math.floor((rest%60000)/1000)).padStart(2,"0");
  document.getElementById("timer").textContent = `‚è≥ ${h}:${m}:${s}`;
}, 1000);

// Visualizer
function makeVisualizer(audId, canId) {
  const audio = document.getElementById(audId);
  const canvas = document.getElementById(canId);
  const ctx = canvas.getContext("2d");
  const actx = new (window.AudioContext || window.webkitAudioContext)();
  const src = actx.createMediaElementSource(audio);
  const analyser = actx.createAnalyser();
  src.connect(analyser);
  analyser.connect(actx.destination);
  analyser.fftSize = 256;
  const buffer = new Uint8Array(analyser.frequencyBinCount);
  function draw() {
    requestAnimationFrame(draw);
    analyser.getByteFrequencyData(buffer);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const barWidth = canvas.width / buffer.length;
    let x = 0;
    for (let v of buffer) {
      const h = v * canvas.height / 255;
      ctx.fillStyle = `hsl(${v+200},100%,50%)`;
      ctx.fillRect(x, canvas.height - h, barWidth, h);
      x += barWidth;
    }
  }
  audio.addEventListener("play", () => actx.resume());
  draw();
}
makeVisualizer("a1","c1");
makeVisualizer("a2","c2");

// Battle sync
onSnapshot(doc(db,"battle","current"), snap => {
  const d = snap.data();
  if (!d) return;
  ["t1","a1","t2","a2"].forEach((id,i)=>{
    const key = i<2?"p1":"p2";
    if (d[key]) {
      document.getElementById(id).textContent = d[key].title;
      document.getElementById(id.replace("t","a")).src = d[key].url;
    }
  });
});

// Vote
window.vote = async p => {
  if (!auth.currentUser) return alert("Connecte-toi pour voter.");
  await setDoc(doc(db,"votes",auth.currentUser.uid),{vote:p});
  alert("Vote enregistr√© !");
};

// Upload
window.upload = async () => {
  const file = document.getElementById("fileInput").files[0];
  const title = document.getElementById("title").value;
  const ai = document.getElementById("aiMaster").checked;
  if (!file || !title) return alert("Fichier + titre requis.");
  let url;
  if (ai) {
    // fake AI mastering
    url = URL.createObjectURL(file);
    alert("IA mastering activ√©e (simulation)");
  } else {
    const ref = ref(storage, file.name);
    await uploadBytes(ref, file);
    url = await getDownloadURL(ref);
  }
  const key = Math.random()>0.5?"p1":"p2";
  await setDoc(doc(db,"battle","current"),{[key]:{title,url}},{merge:true});
  document.getElementById("status").textContent = "‚úÖ Upload termin√© !";
};

// Login
window.login = () => signInWithPopup(auth,provider).then(()=>alert("Connect√© !"));

// NFT Mint (simulation)
window.mintNFT = product => alert(`Minting NFT ${product}‚Ä¶ (simulation)`);
</script>
</body>
</html>
